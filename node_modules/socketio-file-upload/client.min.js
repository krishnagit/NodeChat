/* Socket IO File Upload Client-Side Library
 *   Copyright (C) 2013 Shane Carr
 *   Released under the X11 License
 * For more information, visit: https://github.com/vote539/socketio-file-upload
 */

(function(k,e,f){"function"===typeof define&&define.amd?define(e,f):k[e]=f()})(this,"SocketIOFileUpload",function(){return function(k){var e=this;if(!window.File||!window.FileReader)throw Error("Socket.IO File Upload: Browser Not Supported");var f={},p=[],v=[];e.fileInputElementId="siofu_input";e.useText=!1;e.serializedOctets=!1;e.useBuffer=!0;var r=function(a,b){var c=document.createEvent("Event");c.initEvent(a,!1,!1);for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return e.dispatchEvent(c)},n=[],
g=function(a,b,c,d){a.addEventListener(b,c,d);n.push(arguments)},w=function(a,b,c,d){a.removeEventListener&&a.removeEventListener(b,c,d)},x=function(){for(var a=n.length-1;0<=a;a--)w.apply(this,n[a]);n=[]},y=function(a){if(null!==e.maxFileSize&&a.size>e.maxFileSize)r("error",{file:a,message:"Attempt by client to upload file exceeding the maximum file size",code:1});else if(r("start",{file:a})){var b=new FileReader,c=0,d=p.length,f=e.useText,n;p.push(a);g(b,"progress",function(a){});g(b,"load",function(t){a:{t=
t.loaded;var g,p=!1;if(f)g=b.result.slice(c,t);else try{var m=new Uint8Array(b.result,c,t);if(e.serializedOctets)g=m;else if(e.useBuffer)g=m.buffer;else{var p=!0,l,q=m.buffer.byteLength,h="";for(l=0;l<q;l+=3)h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[m[l]>>2],h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(m[l]&3)<<4|m[l+1]>>4],h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(m[l+1]&15)<<2|m[l+2]>>6],h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[m[l+
2]&63];2===q%3?h=h.substring(0,h.length-1)+"=":1===q%3&&(h=h.substring(0,h.length-2)+"==");g=h}}catch(u){k.emit("siofu_done",{id:d,interrupt:!0});break a}k.emit("siofu_progress",{id:d,start:c,end:t,content:g,base64:p});c=t}k.emit("siofu_done",{id:d});r("load",{file:a,reader:b,name:n})});g(b,"error",function(){k.emit("siofu_done",{id:d,interrupt:!0})});g(b,"abort",function(){k.emit("siofu_done",{id:d,interrupt:!0})});k.emit("siofu_start",{name:a.name,mtime:a.lastModifiedDate,meta:a.meta,encoding:f?
"text":"octet",id:d});v.push(f?function(c){b.readAsText(a);n=c}:function(c){b.readAsArrayBuffer(a);n=c})}},q=function(a){if(0!==a.length){for(var b=0;b<a.length;b++)a[b].meta={};if(r("choose",{files:a}))for(b=0;b<a.length;b++)y(a[b])}},u=function(a){var b=a.target.files||a.dataTransfer.files;a.preventDefault();q(b)};this.submitFiles=function(a){a&&q(a)};this.listenOnSubmit=function(a,b){b.files&&g(a,"click",function(){q(b.files)},!1)};this.listenOnArraySubmit=function(a,b){for(var c in b)this.listenOnSubmit(a,
b[c])};this.listenOnInput=function(a){a.files&&g(a,"change",u,!1)};this.listenOnDrop=function(a){g(a,"dragover",function(a){a.preventDefault()},!1);g(a,"drop",u)};this.prompt=function(){var a;a=document.getElementById(e.fileInputElementId);a||(a=document.createElement("input"),a.setAttribute("type","file"),a.setAttribute("id",e.fileInputElementId),a.style.display="none",document.body.appendChild(a));g(a,"change",u,!1);var b=document.createEvent("MouseEvents");b.initMouseEvent("click",!0,!0,window,
0,0,0,0,0,!1,!1,!1,!1,0,null);a.dispatchEvent(b)};this.destroy=function(){x();var a=document.getElementById(e.fileInputElementId);a&&a.parentNode.removeChild(a)};this.addEventListener=function(a,b){f[a]||(f[a]=[]);f[a].push(b)};this.removeEventListener=function(a,b){if(!f[a])return!1;for(var c=0;c<f[a].length;c++)if(f[a][c]===b)return f[a].splice(c,1),!0;return!1};this.dispatchEvent=function(a){var b=f[a.type];if(!b)return!0;for(var c=!0,d=0;d<b.length;d++)!1===b[d](a)&&(c=!1);return c};k.on("siofu_ready",
function(a){v[a.id](a.name)});k.on("siofu_complete",function(a){r("complete",{file:p[a.id],detail:a.detail,success:a.success})});k.on("siofu_error",function(a){r("error",{file:p[a.id],message:a.message,code:0})})}});
